---
phase: 03-expansion-engine
plan: "01"
subsystem: database
tags: [sql-generation, cte, group-by, identifier-quoting, tdd]

# Dependency graph
requires:
  - phase: 02-storage-and-ddl
    provides: "SemanticViewDefinition model struct (model.rs)"
provides:
  - "expand() function generating CTE-wrapped SQL from semantic view definitions"
  - "QueryRequest and ExpandError types for expansion API"
  - "quote_ident() utility for SQL identifier quoting"
  - "source_table field on Dimension and Metric for future join resolution"
affects: [03-02 (join resolution, fuzzy matching), 03-03 (proptest), 04-query-interface]

# Tech tracking
tech-stack:
  added: []
  patterns: [cte-wrapped-sql, case-insensitive-name-lookup, tdd-red-green]

key-files:
  created: [src/expand.rs]
  modified: [src/model.rs, src/lib.rs]

key-decisions:
  - "All declared joins included in CTE for Plan 01; join pruning deferred to Plan 02"
  - "Case-insensitive name matching via eq_ignore_ascii_case for DuckDB compatibility"
  - "Fuzzy suggestion (strsim) deferred to Plan 02; suggestion field set to None for now"
  - "Dimension/metric expressions emitted verbatim; only identifiers (table names, aliases) are quoted"

patterns-established:
  - "CTE pattern: WITH _base AS (SELECT * FROM table [JOINs] [WHERE]) SELECT ... FROM _base [GROUP BY]"
  - "quote_ident() for all SQL identifiers; raw expressions emitted as-is"
  - "Case-insensitive matching for dimension/metric name lookups"

requirements-completed: [MODEL-01, MODEL-02, MODEL-04, EXPAND-01, EXPAND-04, TEST-01]

# Metrics
duration: 4min
completed: 2026-02-25
---

# Phase 3 Plan 01: Core Expansion Engine Summary

**Pure Rust expand() function generating CTE-wrapped SQL with GROUP BY inference, filter composition, and identifier quoting -- 14 unit tests via TDD**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-24T23:41:30Z
- **Completed:** 2026-02-24T23:45:26Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- expand() generates correct CTE-wrapped SQL for single/multiple dimensions and metrics
- Global aggregate queries (empty dimensions) produce SQL without GROUP BY
- Filter expressions are AND-composed with parentheses in WHERE clause
- Case-insensitive dimension/metric name matching for DuckDB compatibility
- Backward-compatible source_table field added to Dimension and Metric structs
- 14 unit tests covering all expansion scenarios (4 quote_ident + 10 expand)

## Task Commits

Each task was committed atomically:

1. **Task 1: Update model structs and add expand module scaffold** - `9d4e6d5` (feat)
2. **Task 2 RED: Add failing expand() tests** - `52509af` (test)
3. **Task 2 GREEN: Implement expand() function** - `913cfd4` (feat)

_Note: Task 2 follows TDD with separate RED and GREEN commits_

## Files Created/Modified
- `src/expand.rs` - New module: expand(), QueryRequest, ExpandError, quote_ident() with 14 unit tests
- `src/model.rs` - Added source_table: Option<String> to Dimension and Metric with backward compat tests
- `src/lib.rs` - Added pub mod expand declaration

## Decisions Made
- All declared joins are included in the base CTE for Plan 01; join pruning based on source_table is deferred to Plan 02
- Fuzzy match suggestions (strsim) deferred to Plan 02; ExpandError.suggestion is set to None
- Case-insensitive matching uses eq_ignore_ascii_case (not Unicode-aware; ASCII is sufficient for SQL identifiers)
- Expressions (dim.expr, metric.expr, filter strings, join ON clauses) are emitted verbatim -- only identifiers generated by the engine are quoted

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- expand() is ready for Plan 02 to add join resolution (source_table-based pruning) and fuzzy matching (strsim)
- Plan 03 will add proptest property-based tests using the expand() API
- All existing Phase 2 catalog/DDL tests continue to pass (32/32 green)

## Self-Check: PASSED

- FOUND: src/expand.rs
- FOUND: src/model.rs (modified)
- FOUND: src/lib.rs (modified)
- FOUND: commit 9d4e6d5 (Task 1)
- FOUND: commit 52509af (Task 2 RED)
- FOUND: commit 913cfd4 (Task 2 GREEN)
- FOUND: 03-01-SUMMARY.md

---
*Phase: 03-expansion-engine*
*Completed: 2026-02-25*
