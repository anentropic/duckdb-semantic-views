name: DuckDB Version Monitor
on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly, Monday 09:00 UTC
  workflow_dispatch:       # Allow manual trigger for testing

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    name: Check for new DuckDB release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Get latest DuckDB release
        id: latest
        run: |
          LATEST=$(gh api repos/duckdb/duckdb/releases/latest --jq '.tag_name')
          CURRENT=$(grep 'TARGET_DUCKDB_VERSION' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          if [ "$LATEST" != "$CURRENT" ]; then
            echo "is_new=true" >> $GITHUB_OUTPUT
          else
            echo "is_new=false" >> $GITHUB_OUTPUT
          fi
          echo "Latest DuckDB: $LATEST (current pin: $CURRENT)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip if already up to date
        if: steps.latest.outputs.is_new == 'false'
        run: echo "Already on latest DuckDB ${{ steps.latest.outputs.current }}. No action needed."

      - name: Update version pin
        if: steps.latest.outputs.is_new == 'true'
        run: |
          LATEST="${{ steps.latest.outputs.latest }}"
          # Update Makefile version pin
          sed -i "s/TARGET_DUCKDB_VERSION=.*/TARGET_DUCKDB_VERSION=${LATEST}/" Makefile
          # Update MainDistributionPipeline.yml duckdb_version field
          sed -i "s/duckdb_version: .*/duckdb_version: ${LATEST}/" .github/workflows/MainDistributionPipeline.yml
          # Update PullRequestCI.yml duckdb_version field
          sed -i "s/duckdb_version: .*/duckdb_version: ${LATEST}/" .github/workflows/PullRequestCI.yml
          echo "Updated version pin to ${LATEST}"

      - name: Install Rust stable
        if: steps.latest.outputs.is_new == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Build and test against new DuckDB version
        if: steps.latest.outputs.is_new == 'true'
        id: build
        run: make configure && make test_release
        continue-on-error: true

      - name: Open version-bump PR (build passed)
        if: steps.latest.outputs.is_new == 'true' && steps.build.outcome == 'success'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "chore: bump DuckDB pin to ${{ steps.latest.outputs.latest }}"
          body: |
            Automated version bump to DuckDB ${{ steps.latest.outputs.latest }}.

            Build and tests passed on Linux x86_64. The full platform matrix will run once this PR merges to `main`.

            ---
            *Generated by DuckDB Version Monitor workflow.*
          branch: "chore/duckdb-bump-${{ steps.latest.outputs.latest }}"
          commit-message: "chore: bump DuckDB pin to ${{ steps.latest.outputs.latest }}"
          delete-branch: true

      - name: Open breakage PR (build failed)
        if: steps.latest.outputs.is_new == 'true' && steps.build.outcome == 'failure'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "fix: DuckDB ${{ steps.latest.outputs.latest }} broke the build"
          body: |
            Build against DuckDB ${{ steps.latest.outputs.latest }} failed.

            @copilot please update the DuckDB version pin and fix any compilation errors.

            Build log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ---
            *Generated by DuckDB Version Monitor workflow.*
          branch: "fix/duckdb-breakage-${{ steps.latest.outputs.latest }}"
          commit-message: "chore: attempt bump to DuckDB ${{ steps.latest.outputs.latest }}"
          delete-branch: true
